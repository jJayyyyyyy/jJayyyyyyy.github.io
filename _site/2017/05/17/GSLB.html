<!DOCTYPE html>
<html lang="en">
	<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="fXCqEVcHdJt50axIq7sCTxtZUh5gDHkj2usDwI_66gE" />
  <title>全局负载均衡GSLB学习笔记</title>
  <meta name="description" content="">

 <!--  
   -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href= "/">
  <link rel="alternate" type="application/rss+xml" title="FrozenMap" href="/feed.xml">
  
  
</head>

	<body>
		<header class="site-header" role="banner" style="border-top:0px">
  <div class="wrapper">
    <a class="site-title" href="/">Home</a>
    <!-- <img src="/assets/Labtocat.png" width="43"> -->
    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>
      
      <div class="trigger">
          <a class="page-link" href="/about/">About</a>
          <!-- <a class="page-link" href="/donate">Donate</a> -->
          <a class="page-link" href="/feed.xml">RSS</a>
      </div>
    </nav>
  </div>
</header>
		<main class="page-content" aria-label="Content">
			<div class="wrapper">
				<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<header class="post-header">
		<h1 class="post-title" itemprop="name headline">
			全局负载均衡GSLB学习笔记
		</h1>
		<p class="post-meta">
			<span><time datetime="2017-05-17T00:00:00+08:00" itemprop="datePublished">
				May 17, 2017</time> • </span>
			<span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href=http://localhost:4000>FrozenMap</a></span>
		</p>
	</header>
	<div class="post-content" itemprop="articleBody">
		<p><br /><br /></p>

<h3 align="center">摘要</h3>

<p>       <strong>GSLB</strong> 是 <em>Global Server Load Balance</em> 的缩写，即全局负载均衡。本文首先介绍了什么是负载均衡 <strong>SLB</strong> ，以及为什么要使用 <strong>SLB</strong> 。接着引出全局负载均衡 <strong>GSLB</strong> 的概念和作用。为此介绍了其基于 <strong>DNS</strong> 进行解析和分配负载的实现，包括 <strong>DNS</strong> 的原理简介、应用部署中的基本概念、分配负载的决策条件等内容。以外，本文还简单介绍了通过 <strong>HTTP</strong> 和 <strong>IP</strong> 实现 <strong>GSLB</strong> 的方式，并对三者的优缺点进行了简单对比。最后是本文的参考文献。</p>

<p>关键词: <strong>GSLB</strong> , <strong>DNS</strong>, <strong>CDN</strong></p>

<p><br /><br /></p>

<h3 id="目录">目录</h3>

<ul>
  <li><a href="#SLB">1. 负载均衡 SLB</a>
    <ul>
      <li>1.1 SLB的简介与作用</li>
      <li>1.2 SLB关键技术</li>
    </ul>
  </li>
  <li><a href="#GSLB">2. 全局负载均衡 GSLB</a>
    <ul>
      <li>2.1 GSLB的简介与作用</li>
      <li>2.2 DNS原理简介</li>
      <li>2.3 基于DNS的GSLB</li>
      <li>2.4 GSLB的其他实现方式</li>
    </ul>
  </li>
  <li><a href="#Reference">3. 参考文献</a></li>
</ul>

<p><br /><br /></p>

<h3 id="SLB" align="center">1. 负载均衡 SLB</h3>

<h4 id="11-负载均衡及其作用"><strong>1.1 负载均衡及其作用</strong></h4>

<p>负载均衡(Server Load Balance, SLB)，其含义是将负载(工作任务)平衡分散到多个服务器上。<strong>CDN</strong>是典型的负载均衡集群系统。</p>

<p><em>图1.1</em>是负载均衡的示意图。从图中可以看出，负载均衡设备可以在用户请求到达服务器之前将其截获，然后将其分发到合适的后端服务器。</p>

<div align="center">
<img src="https://raw.githubusercontent.com/jJayyyyyyy/jjayyyyyyy.github.io/master/assets/post_images/2017-05-17/SLB.png" alt="SLB" />
<h6>图1.1 SLB示意图</h6>
</div>

<p>也就是说，客户端发出的请求，首先会到负载均衡设备的IP地址上。因为该IP地址并不负责处理实际的业务，所以通常将该地址称为【虚拟IP】(Virtual IP, <strong>VIP</strong>)。</p>

<p>后端真正的业务服务器被称为【真实服务器】(Real Server, <strong>RS</strong>)，其IP地址被称为【真实IP】(Real IP, <strong>RIP</strong>)，负责处理业务。</p>

<p>举个例子，VIP 就像是前台招待，会告诉你办什么事该去哪个房间。而RIP是内部实际办业务的房间号。</p>

<p>利用负载均衡，很大程度上可以避免单个服务器过载或者闲置，前者会引起服务能力下降，后者则没有充分利用资源。因此，为了达到更好的系统处理能力，需要进行以下两个步骤：</p>

<ol>
  <li>在集群前端部署负载均衡设备</li>
  <li>根据预先配置的均衡策略，在集群中智能分发用户请求</li>
</ol>

<p><br /></p>

<h4 id="12-负载均衡关键技术"><strong>1.2 负载均衡关键技术</strong></h4>

<p>要做到负载均衡，需要的问题包括但不限于以下几个方面</p>

<ul>
  <li>请求的分发</li>
  <li>会话保持</li>
  <li>服务健康监测</li>
  <li>故障隔离</li>
  <li>自动恢复</li>
</ul>

<p><strong>1.2.1 请求分发算法</strong></p>

<p>请求分发算法，可以分为【静态算法】和【动态算法】两大类。</p>

<ul>
  <li>
    <p>静态算法</p>

    <p>静态算法是指按照预先设置好的策略进行分发，而不考虑服务器当前的实际负载状况。</p>

    <p>这类算法包括轮询、加权轮询、基于源IP或目的IP的<strong>hash</strong>算法等等，优点是简单快捷。</p>
  </li>
  <li>
    <p>动态算法</p>

    <p>动态算法指的是能够根据当前服务器状况进行分发，包括最小连接，加权最小连接等。</p>
  </li>
</ul>

<p><strong>1.2.2 会话保持</strong></p>

<p>出于一些业务的特殊要求，有时候需要进行会话保持，以保证一段时间内，某一个用户与系统的交互（会话），只交给同一台服务器处理。</p>

<p>例如，大多数电商应用需要用户认证，而一次交易需要与服务器多次交互才能完成。这几次交互必须由同一台服务器处理，而不能被分散到不同服务器上。</p>

<p>会话保持有以下几种方法：</p>

<ul>
  <li>源IP地址的持续性保持</li>
  <li>cookie 持续性保持</li>
  <li>基于HTTP报文头的持续性保持</li>
</ul>

<p><strong>1.2.3 服务器健康检测</strong></p>

<p>为了保证服务质量，需要定时进行健康检测。我们可以利用ICMP、TCP、HTTP、FTP等协议进行检测，即主要是在传输层和应用层进行检测。</p>

<p>应用层的检测颗粒更细，但对系统的要求也比较高，因为需要针对应用层的不同的协议做不同的识别分发机制。应用层检测用的比较多的就是HTTP协议，比如先和集群中的设备建立连接，然后发出请求，如果收到正确应答，则说明HTTP处理正常。</p>

<p>传输层的检测，主要在于能否建立TCP连接，回响是否正常，等等。</p>

<p><br /><br /></p>

<h3 id="GSLB" align="center">2. 全局负载均衡GSLB</h3>

<h4 id="21-gslb的简介与作用"><strong>2.1 GSLB的简介与作用</strong></h4>

<p>GSLB, Global Server Load Balance, 即全局负载均衡。</p>

<p>由于现实中存在各种不稳定因素，比如某个服务器集群所在的数据中心断电，洪水或者地震造成数据中心瘫痪等等。在一个数据中心内，无论采用怎样的技术，总可能存在一些不可抗因素，导致其瘫痪。所以通常会把服务器分散部署到多个数据中心，以最大程度减小灾害对服务质量产生影响的概率和程度。</p>

<p>另外，<strong>CDN</strong>系统总是希望用距离用户最近的设备为其提供服务，这也需要在不同地域部署多个节点。</p>

<p>GSLB系统就是针对这个问题的。它负责多个CDN节点之间相互协作，将各节点和设备的负载保持在一个有利于提供优质服务的水平。GSLB的负载均衡结果可能直接将用户分配到RS，也可能将用户交付到下一层次的负载均衡系统。</p>

<p>经过多年发展，已有多种调度机制可实现CDN的全局负载均衡。其中最常用的是基于DNS的GSLB。</p>

<p><br /></p>

<h4 id="22-dns简介"><strong>2.2 DNS简介</strong></h4>

<p><strong>2.2.1 DNS工作流程</strong></p>

<p>DNS是一个应用层协议，但它通常被其他的应用层协议使用，以便将主机名(host)解析为IP地址。DNS的工作流程如图2.1</p>

<div align="center">
<img src="https://raw.githubusercontent.com/jJayyyyyyy/jjayyyyyyy.github.io/master/assets/post_images/2017-05-17/DNS_workflow.png" alt="DNS_workflow" />
<h6>图2.1 DNS的基本工作流程</h6>
</div>

<p>在第4步中,本地DNS服务器(<code class="highlighter-rouge">Local DNS, LDNS</code>)在得到浏览器解析的域名请求后，会采用迭代或递归查询的方式，向DNS 系统中其他远程域名服务器提出查询请求，如图 2.2 所示。</p>

<div align="center">
<img src="https://raw.githubusercontent.com/jJayyyyyyy/jjayyyyyyy.github.io/master/assets/post_images/2017-05-17/DNS_iterative_query.png" alt="iterative_query" />
<h6>图2.2 域名解析</h6>
</div>

<p>如果<code class="highlighter-rouge">LDNS</code>中没有关于这个域名的缓存，则首先会去根域名服务器请求解析<code class="highlighter-rouge">.root</code>，收到其返回的<code class="highlighter-rouge">.com</code>域的域名服务器列表。LDNS在该列表中选出一个域名服务器，对其发出域名解析请求。</p>

<p>被请求的<code class="highlighter-rouge">.com</code>域的域名会查找<code class="highlighter-rouge">CDNbook.com</code>的权威域名服务器的IP，并将其返回给LDNS。</p>

<p>由于这个权威域名服务器是<code class="highlighter-rouge">CDNbook.com</code>这个域名授权的，所以<code class="highlighter-rouge">LDNS</code>对权威域名服务器请求后就能得到<code class="highlighter-rouge">www.CDNbook.com</code>的IP地址，并将其返回给客户端。</p>

<p>另一方面，如果在<code class="highlighter-rouge">LDNS</code>上有&lt;<code class="highlighter-rouge">www.CDNbook.com</code>—<code class="highlighter-rouge">IP</code>&gt;的缓存记录，就可以直接把这个结果返回给客户 端，节省了中间的递归查找步骤时间和资源开销。</p>

<p><strong>2.2.2 DNS记录的类型</strong></p>

<p>DNS服务器是根据资源记录来对DNS请求进行应答的。其中，最常见的是<code class="highlighter-rouge">Internet</code>类的记录(<code class="highlighter-rouge">Class IN</code>)。<code class="highlighter-rouge">Internet</code>类的记录主要有以下几种类型(<code class="highlighter-rouge">Type</code>):</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">A</code>记录</p>

    <p><code class="highlighter-rouge">A</code>记录即地址<code class="highlighter-rouge">Address</code>记录，对应的<code class="highlighter-rouge">value</code>是域名的<code class="highlighter-rouge">IP</code>地址。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">NS</code>记录</p>

    <p>域名服务器<code class="highlighter-rouge">Name Server</code>记录，保存了下一级域名信息的服务器地址。该记录只能设置为域名,不能设置为<code class="highlighter-rouge">IP</code>地址。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">CNAME</code>记录</p>

    <p>规范名称记录<code class="highlighter-rouge">Canonical Name for an alias</code>，也称为别名记录，其<code class="highlighter-rouge">value</code>是另一个域名。也就是说，将原域名<code class="highlighter-rouge">key</code>映射到了另一个域名<code class="highlighter-rouge">value</code>。</p>

    <p>举个栗子。百度的域名是<code class="highlighter-rouge">www.baidu.com</code>，它的<code class="highlighter-rouge">cname</code>是<code class="highlighter-rouge">www.a.shifen.com</code>。</p>

    <p>那么，我们已经有了一个域名了，为什么还要设置cname呢？假设有<code class="highlighter-rouge">www.domain.com</code>和<code class="highlighter-rouge">mail.domain.com</code>，其cname都指向<code class="highlighter-rouge">host.domain.cdnxxx.com</code>。</p>

    <p>然后某一天，我们的服务器地址(A记录对应的IP地址)可能要变了。由于www和mail都会被引导到<code class="highlighter-rouge">www.domain.wscdn.com</code>，所以这时我们只需修改<code class="highlighter-rouge">host.domain.wscdn.com</code>的A记录，而不必把www和mail的A记录都改一遍。</p>

    <p>因此cname增加了灵活性，在子域多的时候更为明显，相当于进行了批量管理。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">RR</code>记录</p>

    <p>资源记录<code class="highlighter-rouge">Resource Record</code>。一个主机名可以对应多个IP地址，在一个DNS应答报文中可能含有多条<code class="highlighter-rouge">RR</code>信息。</p>
  </li>
</ul>

<p>下面我们使用<code class="highlighter-rouge">nslookup</code>来对上述的几个定义进行具体说明。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ nslookup www.baidu.com

# 返回如下响应
Non-authoritative answer:
www.baidu.com canonical name = www.a.shifen.com.
Name: www.a.shifen.com
Address: 112.80.248.74
Name: www.a.shifen.com
Address: 112.80.248.73
</code></pre>
</div>

<p>首先，<code class="highlighter-rouge">www.baidu.com</code>没有A记录，但是通过<code class="highlighter-rouge">cname</code>被引导到了<code class="highlighter-rouge">www.a.shifen.com.</code>。</p>

<p>其次，<code class="highlighter-rouge">www.a.shifen.com</code>有2条A记录，也就是一个主机对应了2个IP。实际上，如过在不同地区进行DNS请求，则最后得到的这2条A记录也不同。采用某国外VPS进行请求的结果是<code class="highlighter-rouge">14.215.177.38</code>和<code class="highlighter-rouge">14.215.177.37</code>。这么做是为了将不同地区的用户分配其最近的服务节点，以便快速访问。后面的内容将会解释这一点。</p>

<p>//未完待续</p>

<p><br /></p>

<h3 id="Reference">3. 参考文献</h3>

<ul>
  <li>雷葆华. CDN技术详解[M]. 电子工业出版社, 2014.</li>
  <li><a href="http://jaseywang.me/2012/12/13/cdn-%E7%AE%80%E4%BB%8B%E4%B8%89/#more-3661">CDN简介</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2016/06/dns.html">DNS原理入门</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Content_delivery_network">Content Delivery Network - wikipedia</a></li>
</ul>

<p><br /></p>

<p>本文地址：<a href="https://jjayyyyyyy.github.io/2017/05/17/GSLB.html">https://jjayyyyyyy.github.io/2017/05/17/GSLB.html</a></p>

<h6>注：本文最初整理于20160908。接下来将会陆续整理一些以前的学习笔记。</h6>

<p>(END)</p>

<hr />

<h2 id="相关阅读">相关阅读</h2>

	</div>

	<div>
		<br/>
		<!-- great thanks to https://www.rrssb.ml/ -->
		<link rel="stylesheet" href="/css/rrssb/css/rrssb.css" />
		<ul class="rrssb-buttons clearfix" style="display: flex; justify-content: flex-end;">
			<li class="rrssb-facebook small" data-initwidth="14.285714285714286" data-size="67" style="width: 42px;">
				<a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/05/17/GSLB.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
					<span class="rrssb-icon">
						<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid" width="29" height="29" viewBox="0 0 29 29">
							<path d="M26.4 0H2.6C1.714 0 0 1.715 0 2.6v23.8c0 .884 1.715 2.6 2.6 2.6h12.393V17.988h-3.996v-3.98h3.997v-3.062c0-3.746 2.835-5.97 6.177-5.97 1.6 0 2.444.173 2.845.226v3.792H21.18c-1.817 0-2.156.9-2.156 2.168v2.847h5.045l-.66 3.978h-4.386V29H26.4c.884 0 2.6-1.716 2.6-2.6V2.6c0-.885-1.716-2.6-2.6-2.6z" fill-rule="evenodd" class="cls-2"/>
						</svg>
					</span>
					<span class="rrssb-text">facebook</span>
				</a>
			</li>
			<li class="rrssb-twitter small" data-initwidth="14.285714285714286" data-size="53" style="width: 42px;">
				<a href="https://twitter.com/intent/tweet?text=全局负载均衡GSLB学习笔记%20%20http://localhost:4000/2017/05/17/GSLB.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
					<span class="rrssb-icon">
						<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
							<path d="M24.253 8.756C24.69 17.08 18.297 24.182 9.97 24.62c-3.122.162-6.22-.646-8.86-2.32 2.702.18 5.375-.648 7.507-2.32-2.072-.248-3.818-1.662-4.49-3.64.802.13 1.62.077 2.4-.154-2.482-.466-4.312-2.586-4.412-5.11.688.276 1.426.408 2.168.387-2.135-1.65-2.73-4.62-1.394-6.965C5.574 7.816 9.54 9.84 13.802 10.07c-.842-2.738.694-5.64 3.434-6.48 2.018-.624 4.212.043 5.546 1.682 1.186-.213 2.318-.662 3.33-1.317-.386 1.256-1.248 2.312-2.4 2.942 1.048-.106 2.07-.394 3.02-.85-.458 1.182-1.343 2.15-2.48 2.71z"/>
						</svg>
					</span>
					<span class="rrssb-text">twitter</span>
				</a>
			</li>
			<li class="rrssb-googleplus small" data-initwidth="14.285714285714286" data-size="59" style="width: 42px;">
				<a href="https://plus.google.com/share?url=http://localhost:4000/2017/05/17/GSLB.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
					<span class="rrssb-icon">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
							<path d="M21 8.29h-1.95v2.6h-2.6v1.82h2.6v2.6H21v-2.6h2.6v-1.885H21V8.29zM7.614 10.306v2.925h3.9c-.26 1.69-1.755 2.925-3.9 2.925-2.34 0-4.29-2.016-4.29-4.354s1.885-4.353 4.29-4.353c1.104 0 2.014.326 2.794 1.105l2.08-2.08c-1.3-1.17-2.924-1.883-4.874-1.883C3.65 4.586.4 7.835.4 11.8s3.25 7.212 7.214 7.212c4.224 0 6.953-2.988 6.953-7.082 0-.52-.065-1.104-.13-1.624H7.614z"/>
						</svg>
					</span>
					<span class="rrssb-text">google+</span>
				</a>
			</li>
		</ul>
		<br/>
	</div>

	<div style="border-top: dotted #e8e8e8; border-width: 1px 0; padding-top: 10px;">
	</div>

	<div align="center">
		<a rel="cc-license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
			<img alt="Creative Commons License" style="border-width:0" src="https://img.shields.io/badge/%20%20%20CC%20%20%20-BY--NC--SA-brightgreen.svg" /></a>
		<a rel="mit-license" href="http://opensource.org/licenses/mit-license.php">
			<img alt="MIT-License" style="border-width:0" src="https://img.shields.io/badge/License-MIT%20License-blue.svg" /></a>
		<!-- <p>转载请保留作者和出处, 包括以上许可证信息。</p> -->
		<br/><br/><br/>
	</div>

	<div>
		<noscript>Please enable JavaScript to view the comment form powered by <a href="https://commentit.io/">Comm(ent|it)</a></noscript>
		<div id="commentit"></div>
		<script type="text/javascript">
			/** CONFIGURATION VARIABLES **/
			var commentitUsername = 'jJayyyyyyy';
			var commentitRepo = 'jJayyyyyyy/jJayyyyyyy.github.io';
			var commentitPath = '_posts/2017-05-17-GSLB.md';

			/** DON'T EDIT FOLLOWING LINES **/
			(function() {
				var commentit = document.createElement('script');
				commentit.type = 'text/javascript';
				commentit.async = true;
				commentit.src = 'https://commentit.io/static/embed/dist/commentit.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(commentit);
			})();
		</script>
		
		
			<div class="media">
				<div class="media-left">
					<img src="https://avatars2.githubusercontent.com/u/9337766?v=4&s=73" alt="jingb" height="73" width="73">
				</div>
				<div class="media-body">
					<p class="text-muted">
						<a href="https://github.com/jingb">jingb</a> on 21 Jul 2017
					</p>
					<p>
						<p>图片加载不出呀</p>

					</p>
				</div>
			</div>
		
			<div class="media">
				<div class="media-left">
					<img src="https://avatars0.githubusercontent.com/u/8694379?v=4&s=73" alt="jJayyyyyyy" height="73" width="73">
				</div>
				<div class="media-body">
					<p class="text-muted">
						<a href="https://github.com/jJayyyyyyy">jJayyyyyyy</a> on 21 Jul 2017
					</p>
					<p>
						<p>@jingb 链接修复啦</p>

					</p>
				</div>
			</div>
		
			<div class="media">
				<div class="media-left">
					<img src="https://avatars2.githubusercontent.com/u/9337766?v=4&s=73" alt="jingb" height="73" width="73">
				</div>
				<div class="media-body">
					<p class="text-muted">
						<a href="https://github.com/jingb">jingb</a> on 26 Jul 2017
					</p>
					<p>
						<p>什么时候接着填坑呀哈哈</p>

					</p>
				</div>
			</div>
		
	</div>

</article>

			</div>
		</main>
	</body>
</html>
